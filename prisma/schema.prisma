// Prisma schema for √Ångel Shop
// PostgreSQL 15+

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  EXPIRED
  CANCELED
}

enum AdminRole {
  ADMIN
  MANAGER
}

model AppConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Product {
  id          String           @id @default(uuid())
  name        String
  description String?
  category    String?
  garmentType String?
  imageUrl    String?
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  variants    ProductVariant[]
}

model ProductVariant {
  id            String             @id @default(uuid())
  product       Product            @relation(fields: [productId], references: [id])
  productId     String
  sku           String             @unique
  size          String
  color         String
  price         Decimal            @db.Decimal(10, 2)
  stockOnHand   Int                @default(0)
  stockReserved Int                @default(0)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  items         ReservationItem[]
  adjustments   InventoryAdjustment[]

  @@unique([productId, size, color])
}

model Customer {
  id        String    @id @default(uuid())
  name      String?
  email     String?   @unique
  phone     String?   @unique
  isVerified Boolean  @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  reservations Reservation[]
  otps      OtpCode[]
}

model Reservation {
  id             String            @id @default(uuid())
  code           String            @unique
  customer       Customer          @relation(fields: [customerId], references: [id])
  customerId     String
  status         ReservationStatus @default(PENDING)
  expiresAt      DateTime
  expiresInHours Int
  totalAmount    Decimal           @db.Decimal(10, 2)
  depositAmount  Decimal?          @db.Decimal(10, 2)
  note           String?
  analyticsSource String?
  utmSource      String?
  utmMedium      String?
  utmCampaign    String?
  confirmedAt    DateTime?
  expiredAt      DateTime?
  canceledAt     DateTime?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  items          ReservationItem[]
  events         ReservationEvent[]
  adjustments    InventoryAdjustment[]

  @@index([status, expiresAt])
  @@index([customerId, status])
}

model ReservationItem {
  id             String        @id @default(uuid())
  reservation    Reservation   @relation(fields: [reservationId], references: [id])
  reservationId  String
  variant        ProductVariant @relation(fields: [variantId], references: [id])
  variantId      String
  quantity       Int
  unitPrice      Decimal       @db.Decimal(10, 2)
  subtotal       Decimal       @db.Decimal(10, 2)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([variantId])
}

model AdminUser {
  id           String    @id @default(uuid())
  email        String    @unique
  name         String?
  passwordHash String
  role         AdminRole @default(MANAGER)
  lastLoginAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  adjustments  InventoryAdjustment[]
}

model OtpCode {
  id         String   @id @default(uuid())
  target     String
  code       String
  expiresAt  DateTime
  consumedAt DateTime?
  attempts   Int      @default(0)
  createdAt  DateTime @default(now())
  customer   Customer? @relation(fields: [customerId], references: [id])
  customerId String?

  @@index([target])
}

model ReservationEvent {
  id             String      @id @default(uuid())
  reservation    Reservation @relation(fields: [reservationId], references: [id])
  reservationId  String
  actorType      String
  actorId        String?
  eventType      String
  notes          String?
  metadata       Json?
  createdAt      DateTime    @default(now())

  @@index([reservationId])
}

model InventoryAdjustment {
  id             String             @id @default(uuid())
  variant        ProductVariant     @relation(fields: [variantId], references: [id])
  variantId      String
  reservation    Reservation?       @relation(fields: [reservationId], references: [id])
  reservationId  String?
  admin          AdminUser?         @relation(fields: [adminId], references: [id])
  adminId        String?
  reason         String
  quantityChange Int
  notes          String?
  createdAt      DateTime           @default(now())

  @@index([variantId])
  @@index([reservationId])
}
